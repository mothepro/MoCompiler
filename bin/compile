#!/usr/bin/env php
<?php
function help() {
	echo <<<HELP
Mo's PHP Project Compiler!

	Composer Packages for Compression & Uploading
		tpyo/amazon-s3-php-class
		ps/image-optimizer
		apigen/apigen

	Required Options
		-c		Configuration file to use
		-s		Host name of server to compile to
		-p		Location of PPK file to connect to server
		-d		Remote Directory to upload project

	Optional Options
		-h		--help	Print this help message.
	
		-l				Local Directory to load project [Working Directory]
		
		--upload		Directories to move from local to remote

		--twig			Twig Template Directory
		--apigen		Documentation Configuration

		--compress		Compress static files
		--quiet			Silent mode

		--local-sass	Local SASS Directory
		--local-js		Local JS Directory
		--local-img		Local Image Directory

		--s3-key		Amazon S3 Access Key Activates compression
		--s3-secret		Amazon S3 Secret Key

		--remote-sass	Remote Directory to save sass on server or S3
		--remote-js		Remote Directory to save js on server or S3
		--remote-img	Remote Directory to save images on server or S3
HELP;
}

// no errors wanted
set_time_limit(0);
date_default_timezone_set('UTC');
error_reporting(-1);

// options
$opt = getopt('c:s:p:l:d:h', [
	'help',

	'compress',
	'quiet',

	'upload:',
	'twig:',
	'apigen:',
	'local-sass:',
	'local-js:',
	'local-img:',
	's3-key:',
	's3-secret:',
	'remote-sass:',
	'remote-js:',
	'remote-img:',
]);

// just needs a little help
if(isset($opt['h']) || isset($opt['help'])) {
	help();
	exit;
}

// missing requirments
if(!isset($opt['c']) || !isset($opt['s']) || !isset($opt['p']) || !isset($opt['d'])) {
	echo 'Error, missing required option.', PHP_EOL, PHP_EOL;
	help();
	exit(1);
}

// install configuration
require 'vendor/autoload.php';
require $opt['c']; // server app config

$c = new Compiler\Compiler;
$c	->setHost($opt['s'])
	->setPpk($opt['p'])
	->setRemote($opt['d']);

// misc
$c->setCompress(isset($opt['compress']));
$c->setSilent(isset($opt['silent']));

// clean up dumb function
$opt['local-sass'] 	= (isset($opt['local-sass']) ? (is_array($opt['local-sass']) ? $opt['local-sass'] : array($opt['local-sass'])) : []);
$opt['local-js'] 	= (isset($opt['local-js']) ? (is_array($opt['local-js']) ? $opt['local-js'] : array($opt['local-js'])) : []);
$opt['local-img'] 	= (isset($opt['local-img']) ? (is_array($opt['local-img']) ? $opt['local-img'] : array($opt['local-img'])) : []);
$opt['upload'] 		= (isset($opt['upload']) ? (is_array($opt['upload']) ? $opt['upload'] : array($opt['upload'])) : []);

// add directories
foreach($opt['local-sass'] as $dir)	$c->addSASS($dir);
foreach($opt['local-js'] as $dir)	$c->addJS($dir);
foreach($opt['local-img'] as $dir)	$c->addImage($dir);
foreach($opt['upload'] as $dir)		$c->addMove($dir);

// misc
if(isset($opt['l']))				$c->setLocal($opt['l']);
if(isset($opt['twig']))				$c->setLocalTpl($opt['twig']);
if(isset($opt['apigen']))			$c->setLocalDoc($opt['apigen']);

// S3
if(isset($opt['s3-key']) && isset($opt['s3-key']))	$c->setS3($opt['s3-key'], $opt['s3-secret']);

// remote
if(isset($opt['remote-sass']))		$c->setRemoteSASS($opt['remote-sass']);
if(isset($opt['remote-js']))		$c->setRemoteJS($opt['remote-js']);
if(isset($opt['remote-img']))		$c->setRemoteImage($opt['remote-img']);

// start
$c->compile();